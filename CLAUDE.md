# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GraphQL learning repository featuring a simple Todo application with:
- **Backend**: Spring Boot + Spring for GraphQL (Kotlin)
- **Frontend**: React + Relay (TypeScript)
- **Database**: H2 (in-memory)

This project demonstrates both REST and GraphQL APIs with Relay-compliant cursor-based pagination.

## Development Commands

### Server (Spring Boot)

```bash
cd server

# Run the server (starts on port 8080)
./gradlew bootRun

# Run tests
./gradlew test

# Run specific test
./gradlew test --tests "com.example.learn.graphql.controller.graphql.UserGraphQlControllerTest"

# Lint Kotlin code
./gradlew ktlintCheck

# Format Kotlin code
./gradlew ktlintFormat

# Build project
./gradlew build
```

After starting the server, access:
- http://localhost:8080/ - Landing page with links to Swagger UI and GraphiQL
- http://localhost:8080/graphiql - GraphQL interactive query interface
- http://localhost:8080/graphql - GraphQL endpoint

### Client (React + Relay)

```bash
cd client

# Run development server (starts on port 5173)
npm run dev

# Run tests
npm test

# Run tests in UI mode
npm run test:ui

# Run tests once (CI mode)
npm run test:run

# Generate test coverage report
npm run test:coverage

# Lint TypeScript/React code
npm run lint

# Build for production
npm run build

# Update GraphQL schema from running server
npm run updateSchema

# Generate Relay artifacts (watch mode)
npm run relay

# Generate Relay artifacts (once)
npm run relay:gen
```

## Architecture

### Backend Structure

The server follows a standard Spring Boot architecture with GraphQL:

- **Entities** (`server/src/main/kotlin/com/example/learn/graphql/entity/`): JPA entities
  - `User`: User entity with id and name
  - `Todo`: Todo entity with id, userId, title, and isCompleted

- **Repositories** (`server/src/main/kotlin/com/example/learn/graphql/repository/`): Spring Data JPA repositories
  - `UserRepository`: User data access
  - `TodoRepository`: Todo data access with custom pagination queries

- **Controllers** (`server/src/main/kotlin/com/example/learn/graphql/controller/`):
  - `graphql/`: GraphQL controllers using `@QueryMapping`, `@MutationMapping`, and `@SchemaMapping`
  - `rest/`: Traditional REST controllers

- **GraphQL Schema** (`server/src/main/resources/graphql/`):
  - `schema.graphqls`: Base schema with Query and Mutation types
  - `user.graphqls`: User type definition and operations
  - `todo.graphqls`: Todo type definition and operations
  - `relay.graphqls`: Relay specification interfaces (Node, Connection, Edge, PageInfo)

- **Relay Implementation** (`server/src/main/kotlin/com/example/learn/graphql/controller/graphql/relay/`):
  - `NodeIdUtils.kt`: Utility functions for encoding/decoding global node IDs (base64 encoding of "TypeName:id")
  - `Node.kt`: Relay Node interface implementation
  - `NodeGraphQlController.kt`: Handles `node(id: ID!)` query for fetching any object by global ID
  - `connection/`: Connection and Edge implementations for cursor-based pagination
  - `response/`: Response types implementing Relay Node interface

### Frontend Structure

The client uses React with Relay for GraphQL data fetching:

- **Routing** (`client/src/App.tsx`): React Router setup
  - `/`: Home page
  - `/users`: Users list page
  - `/users/new`: Create user page
  - `/users/:userId`: User detail page

- **Components** (`client/src/components/`):
  - `pages/`: Page components corresponding to routes
  - `TodoList/`: Fragment-based component for displaying todos with pagination
  - `TodoListItem/`: Fragment-based component for individual todo items
  - `CreateTodoForm/`: Mutation component for creating todos
  - `Layout/`: App layout and navigation

- **Relay Environment** (`client/src/RelayEnvironment.ts`): Relay configuration pointing to GraphQL endpoint

- **Generated Files** (`**/__generated__/`): Auto-generated TypeScript types and Relay artifacts
  - Generated by `relay-compiler` based on GraphQL fragments and queries in components
  - Never edit these files manually

### Relay Pattern Implementation

This project implements Relay specifications:

1. **Node Interface**: Global object identification
   - All entities (User, Todo) implement the Node interface with globally unique IDs
   - IDs are base64-encoded strings in format: "TypeName:id" (e.g., "User:1" becomes "VXNlcjox")
   - Use `decodeNodeIdAsLong()` extension function to decode IDs in Kotlin controllers

2. **Connection Pattern**: Cursor-based pagination
   - Uses `first` and `after` arguments for forward pagination
   - Returns Connection type with `edges`, `pageInfo`, and `totalCount`
   - `TodoConnection` implements this pattern for user todos
   - Cursors are the node IDs themselves (not separate cursor values)

3. **Fragment Colocation**: UI components declare their data dependencies
   - Each component defines a GraphQL fragment for its data needs
   - Relay automatically composes fragments into queries

### Key Integration Points

- **Schema Sync**: After modifying GraphQL schema on server, run `npm run updateSchema` in client to update `client/schema.graphql`
- **Relay Compilation**: After changing GraphQL queries/fragments, run `npm run relay:gen` to regenerate TypeScript types
- **Database**: H2 in-memory database, initialized from `server/src/main/resources/data.sql` on startup

## Testing

### Backend Tests

- Located in `server/src/test/kotlin/`
- Use SpringMockK for mocking
- GraphQL tests use `spring-graphql-test` framework
- Run individual test classes with `./gradlew test --tests "ClassName"`

### Frontend Tests

- Located in `client/src/components/**/*.test.tsx`
- Use Vitest + React Testing Library
- Setup file: `client/src/test/setup.ts`
- Run with `npm test` for watch mode or `npm run test:run` for CI mode
